<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Cac Application - QoS</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
            integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
            crossorigin="anonymous"
        >
        <link rel="stylesheet" type="text/css" href="./ryu.topology.css">
    </head>
    <!-- Latest compiled and minified CSS -->
    <style type="text/css">
        #metrics-report {
            border: 1px solid #000;
            padding: 5px 10px;
            height: 300px;
            width: 100%;
            font-size: 12px;
            font-family: Arial;
            font-weight: normal;
            font-style: italic;
            display: block;
            overflow-y: scroll;
        }
    </style>
    <body>
        <main id="application" class="container">
            <section class="row concurrentCalls">
                <div class="col-md-6">
                    <table id="qos-status" class="table table-bordered stripped">
                        <thead>
                            <th>From</th>
                            <th>To</th>
                            <th>QoS</th>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="counters">
                        <div class="counter col-md-4">
                            <label>Concurrent Calls</label>
                            <input id="total-channel-calls" type="text" class="form-control" value="0" />
                        </div>
                        <div class="counter col-md-4">
                            <label>Calls Dropped CAC</label>
                            <input id="cacThreshold" type="text" class="form-control" value="0" />
                        </div>
                        <div class="counter col-md-4">
                            <label>Call Threshhold</label>
                            <input type="text" class="form-control" value="2" />
                        </div>
                    </div>
                </div>
            </section>
            <section class="row logs">
                <div class="col-md-6 ryu-controller-loggs">
                    <div id="metrics-report"></div>
                    <button id="getMetrics">Get Metrics</button>
                    <button id="getPorts">Get Ports</button>
                    <button id="setQoSRules">Set QoS Rules</button>
                    <button id="setQoSQueue">Set QoS Queue</button>
                    <button id="setTopo1">Set Topo 1</button>
                    <button id="setTopo2">Set Topo 2</button>
                    <button id="getNetGraph"><a href='http://localhost:8080'>getNetGraph</a></button>
                </div>
                <div class="col-md-6 charts">
                    <h5>Charts</h5>
                </div>
            </section>
        </main>

    </body>
    <script>
        var wsFront = new WebSocket("ws://10.0.2.15:8000/");
        const getMetricsButton = document.getElementById('getMetrics');
        const getPortsButton = document.getElementById('getPorts');
        const setQoSRulesButton = document.getElementById('setQoSRules');
        const setQoSQueueButton = document.getElementById('setQoSQueue');
        const setTopo1Button = document.getElementById('setTopo1');
        const setTopo2Button = document.getElementById('setTopo2');

        const metricsContainer = document.getElementById('metrics-report');
        const qosStatusTable = document.getElementById('qos-status');
        const inputCalls = document.getElementById('total-channel-calls');
        const inputcacThreshold = document.getElementById('cacThreshold');

        getMetricsButton.addEventListener('click', e => {
            sendMessage( 'getMetrics' )
        });
        getPortsButton.addEventListener('click', e => {
            sendMessage( 'getPorts' )
        });
        setQoSRulesButton.addEventListener('click', e => {
            sendMessage( 'setQoSRules' )
        });
    
        setQoSQueueButton.addEventListener('click', e => {
            sendMessage( 'setQoSQueue' )
        });

        setTopo1Button.addEventListener('click', e => {
            sendMessage( 'setTopo1' )
        });

        setTopo2Button.addEventListener('click', e => {
            sendMessage( 'setTopo2' )
        });

        const newChannelFormatter = (newChannel) => {
            const channelRow = qosStatusTable.insertRow(1);
            const fromCell = channelRow.insertCell(0);
            const toCell = channelRow.insertCell(1);
            const QoSCell = channelRow.insertCell(2);
            fromCell.innerHTML = newChannel.currentNewChannel[1][1];
            toCell.innerHTML = newChannel.currentNewChannel[7][1].exten;
            QoSCell.innerHTML = "";
        }

        const totalChannelsFormater = (total) => {
            inputCalls.value = total
        }

        wsFront.onmessage = function (event) {
            console.log(event.data);
            if (event.data instanceof Blob) {
                reader = new FileReader();
                reader.addEventListener('loadend', (e) => {
                    const text = e.target.result;
                    try {
                        console.log('text', text);
                        const jsonResponse = JSON.parse(text);
                        console.log('text', jsonResponse);
                        if (jsonResponse.notificationType === "newChannel") {
                            newChannelFormatter(jstonResponse.data);
                        }
                    } finally {
                        const lastContent = metricsContainer.innerHTML;
                        metricsContainer.innerHTML = lastContent + text;
                    }
                });
                reader.readAsText(event.data);
            } else {
                const text = (event.data !== "Ping") ? JSON.parse(event.data) : event.data;

                const jsonResponse = text;
                if (jsonResponse.notificationType === "newChannel") {
                    newChannelFormatter(jsonResponse.data);
                    totalChannelsFormater(jsonResponse.data.totalChannels)
                } else if (jsonResponse.notificationType === "closeChannel") {
                    totalChannelsFormater(jsonResponse.data.totalChannels)
                } else if (jsonResponse.notificationType === "cacTrigger") {
                    inputcacThreshold.value = Number(inputcacThreshold.value) + Number(jsonResponse.data.data)
                }

                const lastContent = metricsContainer.innerHTML;
                metricsContainer.innerHTML = lastContent + event.data;
            }
        };

        wsFront.onopen = function () {
            sendMessage( 'Ping' )
        };

        sendMessage = function( command ) {
            wsFront.send( command )
        }

        wsFront.onerror = function (error) {
            console.log('WebSocket Error ', error);
        };
    </script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="./ryu.topology.js" charset="utf-8"></script>
</html>


